<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Baseball Player Search</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#results { border: 1px solid #ccc; max-width: 400px; }
#results div { padding: 5px; cursor: pointer; }
#results div:hover { background-color: #f0f0f0; }
</style>
</head>
<body>
<h1>Baseball Player Search</h1>
<input type="text" id="search" placeholder="Type a player's name..." autocomplete="off" />
<input type="number" id="year" placeholder="Year" min="1901" max="2023" value="2023" style="width:80px; margin-left:5px;" />
<div id="results"></div>
<div id="playerStats"></div>
<script>
const searchInput = document.getElementById('search');
const resultsDiv = document.getElementById('results');
const statsDiv = document.getElementById('playerStats');

let debounceTimeout;

searchInput.addEventListener('input', function() {
  const query = this.value.trim();
  clearTimeout(debounceTimeout);
  if (query.length === 0) {
    resultsDiv.innerHTML = '';
    return;
  }
  debounceTimeout = setTimeout(() => searchPlayers(query), 300);
});

function searchPlayers(query) {
  fetch(`https://statsapi.mlb.com/api/v1/people/search?names=${encodeURIComponent(query)}&sportId=1&limit=10`)
    .then(response => response.json())
    .then(data => {
      resultsDiv.innerHTML = '';
      if (Array.isArray(data.people)) {
        data.people.forEach(person => {
          const div = document.createElement('div');
          div.textContent = person.fullFMLName || person.fullName;
          div.addEventListener('click', () => {
            searchInput.value = div.textContent;
            resultsDiv.innerHTML = '';
            fetchPlayerAndSimilar(person.id);
          });
          resultsDiv.appendChild(div);
        });
      }
    })
      .catch(err => console.error(err));
}

async function fetchPlayerAndSimilar(id) {
  const year = document.getElementById('year').value || '2023';
  statsDiv.textContent = 'Loading stats...';
  try {
    const personData = await fetch(`https://statsapi.mlb.com/api/v1/people/${id}`).then(r => r.json());
    const person = personData.people[0];
    const isPitcher = person.primaryPosition && person.primaryPosition.abbreviation === 'P';
    const group = isPitcher ? 'pitching' : 'hitting';
    const statsData = await fetch(`https://statsapi.mlb.com/api/v1/people/${id}/stats?stats=season&group=${group}&season=${year}`)
      .then(r => r.json());
    const statsObj = statsData.stats[0];
    if (!statsObj || !statsObj.splits.length) throw new Error('No stats');
    const playerMetrics = computeMetrics(statsObj.splits[0].stat, isPitcher);
    let best;
    for (let y = 1901; y <= 2023; y++) {
      const allData = await fetch(`https://statsapi.mlb.com/api/v1/stats?stats=season&group=${group}&season=${y}&playerPool=qualified&limit=300`).then(r => r.json());
      if (!allData.stats || !allData.stats[0] || !allData.stats[0].splits) continue;
      allData.stats[0].splits.forEach(split => {
        if (split.player.id === id && y.toString() === year) return;
        const m = computeMetrics(split.stat, isPitcher);
        const diff = similarity(playerMetrics, m, isPitcher);
        if (!best || diff < best.diff) {
          best = { diff, player: split.player, metrics: m, year: y };
        }
      });
    }
    if (best) displayStats(person, playerMetrics, best, year);
    else statsDiv.textContent = 'No similar player found.';
  } catch (err) {
    statsDiv.textContent = 'Error loading stats.';
    console.error(err);
  }
}

function parseWar(stat) {
  const val = stat.war ?? stat.winsAboveReplacement;
  if (val === undefined || val === null) return null;
  const num = parseFloat(val);
  return isNaN(num) ? null : num;
}

function computeMetrics(stat, isPitcher) {
  if (isPitcher) {
    const bf = Number(stat.battersFaced) || 0;
    const bbRate = bf ? (Number(stat.baseOnBalls) / bf) * 100 : 0;
    const soRate = bf ? (Number(stat.strikeOuts) / bf) * 100 : 0;
    return {
      ERA: parseFloat(stat.era),
      WAR: parseWar(stat),
      BBp: bbRate,
      SOp: soRate
    };
  } else {
    const pa = Number(stat.plateAppearances) || 0;
    const bbRate = pa ? (Number(stat.baseOnBalls) / pa) * 100 : 0;
    const kRate = pa ? (Number(stat.strikeOuts) / pa) * 100 : 0;
    return {
      AVG: parseFloat(stat.avg),
      WAR: parseWar(stat),
      OBP: parseFloat(stat.obp),
      OPS: parseFloat(stat.ops),
      BBp: bbRate,
      Kp: kRate
    };
  }
}

function similarity(a, b, isPitcher) {
  let sum = 0;
  if (isPitcher) {
    sum += Math.abs(a.ERA - b.ERA);
    if (a.WAR != null && b.WAR != null) sum += Math.abs(a.WAR - b.WAR);
    sum += Math.abs(a.BBp - b.BBp);
    sum += Math.abs(a.SOp - b.SOp);
  } else {
    sum += Math.abs(a.AVG - b.AVG);
    if (a.WAR != null && b.WAR != null) sum += Math.abs(a.WAR - b.WAR);
    sum += Math.abs(a.OBP - b.OBP);
    sum += Math.abs(a.OPS - b.OPS);
    sum += Math.abs(a.BBp - b.BBp);
    sum += Math.abs(a.Kp - b.Kp);
  }
  return sum;
}

function displayStats(player, metrics, best, year) {
  let table = `<h2>Similarity Results (${year})</h2><table border="1" cellpadding="5"><tr><th>Stat</th><th>${player.fullName}</th><th>${best.player.fullName} (${best.year})</th></tr>`;
  if (metrics.AVG !== undefined) {
    table += `<tr><td>AVG</td><td>${metrics.AVG}</td><td>${best.metrics.AVG}</td></tr>`;
    table += `<tr><td>WAR</td><td>${metrics.WAR ?? 'N/A'}</td><td>${best.metrics.WAR ?? 'N/A'}</td></tr>`;
    table += `<tr><td>OBP</td><td>${metrics.OBP}</td><td>${best.metrics.OBP}</td></tr>`;
    table += `<tr><td>OPS</td><td>${metrics.OPS}</td><td>${best.metrics.OPS}</td></tr>`;
    table += `<tr><td>BB%</td><td>${metrics.BBp.toFixed(1)}</td><td>${best.metrics.BBp.toFixed(1)}</td></tr>`;
    table += `<tr><td>K%</td><td>${metrics.Kp.toFixed(1)}</td><td>${best.metrics.Kp.toFixed(1)}</td></tr>`;
  } else {
    table += `<tr><td>ERA</td><td>${metrics.ERA}</td><td>${best.metrics.ERA}</td></tr>`;
    table += `<tr><td>WAR</td><td>${metrics.WAR ?? 'N/A'}</td><td>${best.metrics.WAR ?? 'N/A'}</td></tr>`;
    table += `<tr><td>BB%</td><td>${metrics.BBp.toFixed(1)}</td><td>${best.metrics.BBp.toFixed(1)}</td></tr>`;
    table += `<tr><td>SO%</td><td>${metrics.SOp.toFixed(1)}</td><td>${best.metrics.SOp.toFixed(1)}</td></tr>`;
  }
  table += '</table>';
  statsDiv.innerHTML = table;
}
</script>
</body>
</html>
